@using AutoNest.Models.Carts
@model CartModel
<h1>Shopping Cart</h1>

@if (Model?.Items?.Any() == true)
{
    <table class="table">
        <thead>
            <tr>
                <th>Brand</th>
                <th>Model</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Items)
            {
                <tr>
                    <td>@item.Brand</td>
                    <td>@item.Model</td>
                    <td>@item.Price.ToString("C")</td>
                    <td>
                        <input type="number" class="quantity-input form-control" value="@item.Quantity" min="1" style="width: 60px; display: inline-block;">
                    </td>
                    <td>@((item.Price * item.Quantity).ToString("C"))</td>
                    <td>
                        <a asp-controller="Cart" asp-action="RemoveFromCart" asp-route-partId="@item.PartId"
                           class="btn btn-danger">Remove</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <h3>Total: @Model.TotalPrice.ToString("C")</h3>
}
else
{
    <p>Your cart is empty.</p>
}
<script>
        document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".quantity-input").forEach(input => {
            input.addEventListener("change", function () {
                let row = this.closest("tr");
                let partId = row.getAttribute("data-part-id");
                let quantity = this.value;
                let price = parseFloat(row.querySelector(".price").innerText.replace(/[^0-9.]/g, ""));

                if (quantity < 1) {
                    this.value = 1;
                    quantity = 1;
                }

                fetch("/Cart/UpdateQuantity", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    body: JSON.stringify({ partId, quantity })
                })
                .then(response => response.json())
                .then(data => {
                    row.querySelector(".total").innerText = data.itemTotal;
                    document.getElementById("cart-total").innerText = data.cartTotal;
                })
                .catch(error => console.error("Error:", error));
            });
        });
    });
</script>