@using AutoNest.Models.Carts
@model CartModel

<div class="container mt-4">
    <h2 class="mb-3">Количка</h2>

    @if (Model?.Items?.Any() == true)
    {
        <div class="row">
            <!-- Cart Items -->
            <div class="col-md-8">
                <div class="card p-3">
                    @foreach (var item in Model.Items)
                    {
                        <div class="row mb-3 pb-3 border-bottom align-items-center">
                            <!-- Product Image -->
                            <div class="col-3">
                                <img src="@item.ImageUrl" class="img-fluid rounded" alt="@item.Brand @item.Model">
                            </div>
                            <!-- Product Details -->
                            <div class="col-9">
                                <h5 class="fw-bold">@item.Brand @item.Model</h5>
                                <p class="text-muted small">Part ID: @item.PartId</p>
                                <div class="d-flex align-items-center">
                                    <label class="me-2">Количество:</label>
                                    <input type="number" class="quantity-input form-control text-center" value="@item.Quantity" min="1" style="width: 60px;">
                                </div>
                                <p class="price mt-2 fw-semibold text-danger">@item.Price.ToString("C")</p>
                                <p class="total fw-bold">@((item.Price * item.Quantity).ToString("C"))</p>
                                <a asp-controller="Cart" asp-action="RemoveFromCart" asp-route-Id="@item.PartId" data-id="@item.PartId"
                                   class="btn btn-outline-danger btn-sm">Премахни</a>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-md-4">
                <div class="card p-3">
                    <h4 class="fw-bold">Вашата поръчка</h4>
                    <p><strong>Обща цена на продуктите:</strong> <span id="cart-total" class="fw-bold text-danger">@Model.TotalPrice.ToString("C")</span></p>
                    <a class="btn btn-danger w-100 mb-2" asp-controller="Order" asp-action="Order">Направи поръчка</a>
                </div>
            </div>
        </div>
    }
    else
    {
        <p class="text-center text-muted">Вашата количка е празна.</p>
    }
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".quantity-input").forEach(input => {
            input.addEventListener("change", function () {
                let row = this.closest(".row");
                let partIdElement = row.querySelector("a[data-id]");

                if (!partIdElement) {
                    console.error("Part ID element not found.");
                    return;
                }

                let partId = partIdElement.getAttribute("data-id");
                let quantity = parseInt(this.value);
                let priceElement = row.querySelector(".price");

                if (!priceElement) {
                    console.error("Price element not found.");
                    return;
                }

                let price = parseFloat(priceElement.textContent.trim().replace(/[^0-9.]/g, ""));

                if (isNaN(quantity) || quantity < 1) {
                    this.value = 1;
                    quantity = 1;
                }

                fetch("/Cart/UpdateCart", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Requested-With": "XMLHttpRequest"
                    },
                    body: JSON.stringify({ partId, quantity })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    row.querySelector(".total").textContent = data.itemTotal;

                    let cartTotalElement = document.getElementById("cart-total");
                    if (cartTotalElement) {
                        cartTotalElement.textContent = data.cartTotal;
                    }
                })
                .catch(error => console.error("Error updating cart:", error));
            });
        });
    });
</script>
